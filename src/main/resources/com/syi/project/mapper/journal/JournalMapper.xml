<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- MyBatis 매퍼 XML 파일의 시작 -->
<mapper namespace="com.syi.project.mapper.journal.JournalMapper">

	<resultMap id="journalResultMap" type="com.syi.project.model.journal.JournalVO">
	    <id property="journalNo" column="JOURNAL_NO"/>
	    <result property="journalWriteDate" column="JOURNAL_WRITEDATE"/>
	    <result property="journalRegDate" column="JOURNAL_REGDATE"/>
	    <result property="journalModify" column="JOURNAL_MODIFY"/>
	    <result property="journalTitle" column="JOURNAL_TITLE"/>
	    <result property="fileName" column="FILE_NAME"/>
	</resultMap>

	<!-- 일지 등록  -->
	<insert id="journalEnroll" parameterType="com.syi.project.model.journal.JournalVO">
		INSERT INTO JOURNAL (JOURNAL_TITLE, JOURNAL_WRITEDATE, FILE_NAME)
		VALUES
		(#{journalTitle}, #{journalWriteDate}, #{fileName})
	</insert>

	<!-- 일지 목록 조회 (+ 페이지네이션, 검색) -->
	<select id="journalList" resultMap="journalResultMap">
	    <![CDATA[
	    SELECT * 
	    FROM (
	        SELECT rn, JOURNAL_NO, JOURNAL_TITLE, JOURNAL_WRITEDATE, FILE_NAME
	        FROM (
	            SELECT JOURNAL_NO, JOURNAL_TITLE, JOURNAL_WRITEDATE, FILE_NAME,
	                   ROW_NUMBER() OVER (ORDER BY JOURNAL_NO DESC) AS rn
	            FROM JOURNAL
	            WHERE 1=1
	    ]]>
	    
	    <!-- 제목 검색 조건 -->
	    <if test="keyword != null and keyword != ''">
	        AND JOURNAL_TITLE LIKE '%' || #{keyword} || '%'
	    </if>
	    
	    <!-- 작성일자 필터링 조건 -->
	    <if test="year != null and year != ''">
	        AND EXTRACT(YEAR FROM JOURNAL_WRITEDATE) = #{year}
	    </if>
	    <if test="month != null and month != ''">
	        AND EXTRACT(MONTH FROM JOURNAL_WRITEDATE) = #{month}
	    </if>
	    
	    <![CDATA[
	        )
	        WHERE rn > (#{pageNum} - 1) * #{amount} AND rn <= #{pageNum} * #{amount}
	    )
	    ]]>
	</select>

	<!-- 일지 총 갯수 조회 쿼리 -->
	<select id="journalGetTotal" resultType="int">
	    SELECT count(*) 
	    FROM JOURNAL
	    WHERE 1=1
	    
	    <!-- 제목 검색 조건 -->
	    <if test="keyword != null and keyword != ''">
	        AND JOURNAL_TITLE LIKE '%' || #{keyword} || '%'
	    </if>
	    
	    <!-- 작성일자 필터링 조건 -->
	    <if test="year != null and year != ''">
	        AND EXTRACT(YEAR FROM JOURNAL_WRITEDATE) = #{year}
	    </if>
	    <if test="month != null and month != ''">
	        AND EXTRACT(MONTH FROM JOURNAL_WRITEDATE) = #{month}
	    </if>
	</select>
	
	<!-- 일지 상세 조회 -->
	<select id="journalDetail" resultMap="journalResultMap">
		select * from journal where journal_no = #{journalNo}
	</select>
	
	<!-- 일지 수정 -->
	<update id="journalModify" parameterType="com.syi.project.model.journal.JournalVO">
	    UPDATE JOURNAL
	    SET
	        JOURNAL_TITLE = #{journalTitle},
	        JOURNAL_WRITEDATE = #{journalWriteDate},
	        FILE_NAME = #{fileName}
	    WHERE
	        JOURNAL_NO = #{journalNo}
	</update>
	
	<!-- 일지 삭제 -->
	<delete id="journalDelete">
		delete from journal where journal_no = #{journalNo}
	</delete>
	

</mapper>
